<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AirTaxi - Book Your Flight</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Fonts and Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          integrity="sha512-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Awesomplete CSS for Autocomplete -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" 
          integrity="sha512-t7c1K3UcmxnD9ycGkfdaGkXKa3lL2VAVD1EJrqP7D/BYpRLcJk9I/n3XQu1vZrKyQ5GrQBuXcMfdQR3KjfzCkA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Leaflet.js CSS with specific integrity hash -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" 
          integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKL5FI8nIB4pLchPwzEDHnRIqwl//yk8Sbfw3SHxGh+uZBZMRmLNrQ+0w==" 
          crossorigin="anonymous" />

    <!-- Stylesheet -->
    <style>
        /* Root Variables */
        :root {
            --primary: #0062ff;
            --secondary: #4caf50;
            --accent: #f59e0b;
            --dark: #1a1a1a;
            --light: #ffffff;
            --gray: #f5f7fa;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --error: #e74c3c;
            --success: #28a745;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --nav-bg: rgba(255, 255, 255, 0.95);
            --nav-text: #333333;
            --transition: all 0.3s ease;
        }

        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header Styles */
        header {
            background: var(--nav-bg);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 40px;
            transition: transform 0.3s ease;
        }

        nav ul {
            display: flex;
            gap: 2rem;
                list-style: none;
        }

        nav a {
            color: var(--nav-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            transition: var(--transition);
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        nav a:hover, nav a.active {
            color: var(--primary);
            background: var(--gray);
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--light);
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--text-primary);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid var(--gray);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Main Content Styles */
        .main-container {
            max-width: 1200px;
            margin: 100px auto 40px; /* Adjusted top margin to account for fixed header */
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 40px;
            align-items: start;
        }

        .booking-info {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .booking-info h2 {
            color: var(--text-primary);
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        .info-text {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .features {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray);
            border-radius: 8px;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .feature-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Booking Form Styles */
        .booking-form {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .form-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--gray);
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 98, 255, 0.1);
        }

        .form-group input[readonly] {
            background-color: var(--background);
            cursor: not-allowed;
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1rem;
            width: 100%;
        }

        .submit-btn:hover {
            background: #0052d6;
            transform: translateY(-1px);
        }

        .message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        .message.success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            display: block;
        }

        .message.error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--error);
            display: block;
        }

        /* Search Results Styles */
        .results-section {
            margin-top: 2rem;
        }

        .result-card {
            background: var(--gray);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-details h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .result-details p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .book-btn {
            background: var(--secondary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .book-btn:hover {
            background: #3e8e41;
            transform: translateY(-1px);
        }

        /* Footer Styles */
        footer {
            background: var(--dark);
            color: var(--light);
            padding: 4rem 0;
        }

        .footer-grid {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 3rem;
        }

        .footer-section h4 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.75rem;
        }

        .footer-links a {
            color: var(--light);
            opacity: 0.8;
            text-decoration: none;
            transition: opacity 0.3s ease;
        }

        .footer-links a:hover {
            opacity: 1;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-links a {
            color: var(--light);
            font-size: 1.5rem;
            opacity: 0.8;
            transition: var(--transition);
        }

        .social-links a:hover {
            opacity: 1;
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 968px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            nav ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                right: 20px;
                background: var(--nav-bg);
                padding: 1rem;
                border-radius: 8px;
                box-shadow: var(--shadow);
                width: 200px;
            }

            nav ul.active {
                display: flex;
            }

            .hamburger {
                display: block;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--nav-text);
            }

            .auth-buttons {
                display: none;
            }

            /* Booking Form Adjustments for Mobile */
            .booking-form {
                padding: 1.5rem;
            }

            .booking-info {
                padding: 1.5rem;
            }
        }

        /* Awesomplete Custom Styles */
        .awesomplete {
            width: 100%;
        }

        /* Map Container Styles */
        .map-container {
            width: 100%; /* Ensure full width */
            height: 600px;
            margin: 2rem 0; /* Adjusted margins */
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Main map */
        #map {
    width: 100%;
    height: 100vh; /* Set height to viewport height */
    position: relative;
    z-index: 1;
}


        /* Leaflet specific overrides */
        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
            background: none;
        }

        .leaflet-tile-container img {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Hide tile gaps */
        .leaflet-tile-container {
            background: #f5f5f5;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .map-container {
                width: 100%; /* Ensure full width on mobile */
                height: 450px;
            }
        }

        /* Loading Message Styles */
        .loading-message, .error-message {
            text-align: center;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header>
        <div class="nav-container">
            <div class="logo">
                <img src="logo.png" alt="AirTaxi Logo">
            </div>
            <nav>
                <ul id="navLinks">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="bookings.html">Book Now</a></li>
                    <li><a href="home.html#trips">My Flights</a></li>
                    <li><a href="home.html#services">Services</a></li>
                    <li><a href="home.html#about">About</a></li>
                    <li><a href="home.html#contact">Contact</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='profile.html'">My Profile</button>
                <button class="btn btn-primary" onclick="logout()">Logout</button>
            </div>
            <div class="hamburger" id="hamburgerMenu" style="display: none;">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Booking Information Section -->
        <div class="booking-info">
            <h2>Book Your Flight</h2>
            <p class="info-text">
                Experience the convenience of urban air mobility. Book your air taxi now and enjoy a swift and luxurious journey above the city traffic.
            </p>
            <div class="features">
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="feature-text">
                        <strong>Transparent Pricing</strong><br>
                        No hidden charges, upfront costs
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                    <div class="feature-text">
                        <strong>Instant Booking</strong><br>
                        Confirm your flight in minutes
                    </div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                    <div class="feature-text">
                        <strong>Safety Assured</strong><br>
                        Certified pilots and aircraft
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Form Section -->
        <div class="booking-form">
            <h3 class="form-title">Enter Booking Details</h3>
            <form id="bookingForm" class="form-grid">
                <!-- Pickup Location -->
                <div class="form-group">
                    <label for="pickup">Pickup Location</label>
                    <input type="text" id="pickup" name="pickup" placeholder="Enter pickup location" required aria-label="Pickup Location" class="awesomplete">
                </div>

                <!-- Drop Location -->
                <div class="form-group">
                    <label for="drop">Drop Location</label>
                    <input type="text" id="drop" name="drop" placeholder="Enter drop location" required aria-label="Drop Location" class="awesomplete">
                </div>

                <!-- Date of Travel -->
                <div class="form-group">
                    <label for="date">Date of Travel</label>
                    <input type="date" id="date" name="date" required aria-label="Date of Travel">
                </div>

                <!-- Preferred Time -->
                <div class="form-group">
                    <label for="time">Preferred Time</label>
                    <input type="time" id="time" name="time" required aria-label="Preferred Time">
                </div>

                <!-- Number of Passengers -->
                <div class="form-group">
                    <label for="passengers">Number of Passengers</label>
                    <select id="passengers" name="passengers" required aria-label="Number of Passengers">
                        <option value="" disabled selected>Select passengers</option>
                        <option value="1">1 Passenger</option>
                        <option value="2">2 Passengers</option>
                        <option value="3">3 Passengers</option>
                        <option value="4">4 Passengers</option>
                    </select>
                </div>

                <!-- Estimated Price -->
                <div class="form-group">
                    <label for="price">Estimated Price (INR)</label>
                    <input type="text" id="price" name="price" readonly aria-label="Estimated Price">
                </div>

                <!-- Submit Button -->
                <button type="submit" class="submit-btn">Search Taxis</button>
            </form>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="spinner"></div>

            <!-- Message Divs -->
            <div id="formMessage" class="message"></div>
            <div id="authError" class="message"></div>

            <!-- Search Results Section -->
            <section class="results-section" id="resultsSection">
                <!-- Dynamic taxi search results will appear here -->
            </section>

            <!-- Map Container -->
            <div class="map-container">
                <!-- Leaflet Map -->
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer>
        <div class="footer-grid">
            <div class="footer-section">
                <h4>About AirTaxi</h4>
                <p>Experience the future of urban mobility with our premium air taxi service.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul class="footer-links">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="bookings.html">Book Now</a></li>
                    <li><a href="home.html#trips">My Flights</a></li>
                    <li><a href="home.html#services">Services</a></li>
                    <li><a href="home.html#about">About Us</a></li>
                    <li><a href="home.html#contact">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <ul class="footer-links">
                    <li><i class="fas fa-phone"></i> +1 234 567 890</li>
                    <li><i class="fas fa-envelope"></i> info@airtaxi.com</li>
                    <li><i class="fas fa-map-marker-alt"></i> 123 Aviation Street, Sky City</li>
                </ul>
            </div>
        </div>
    </footer>
    
    <!-- Scripts (Ensure to include Leaflet.js and your custom scripts below) -->
    <!-- Example:
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" integrity="sha512..." crossorigin="anonymous"></script>
    <script src="path/to/your/script.js"></script>
    -->
</body>
</html>

    <!-- Scripts -->
    <!-- Leaflet.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" 
            integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" 
            crossorigin="anonymous"></script>

    <!-- Awesomplete JS for Autocomplete -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js" 
            integrity="sha512-0vZ4N6kYyb+o2MfEtzZ/B0Ul4pMiaLzV0ppzTg2D8oFhMlb4pJpC7sddUMa/jFvNh+xtgx1O1g1D8e+4KTXZ4g==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Fetch Polyfill for Older Browsers (Optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.6.2/fetch.min.js" 
            integrity="sha512-sRn1V70f0O6x1kdxz34w8Z9ZkT7yoNRXV6ilNIs39aGwWwXpc/v3dpacX8uNFpUjdE7hwM54Ww+jFKsXbihehw==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        // Initialize Awesomplete for Autocomplete using Nominatim
        function initializeAutocomplete() {
            const pickupInput = document.getElementById('pickup');
            const dropInput = document.getElementById('drop');

            // Function to fetch suggestions from Nominatim
            async function fetchSuggestions(query) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query)}`, {
                        headers: {
                            'Accept-Language': 'en' // Optional: set language
                        }
                    });
                    const data = await response.json();
                    return data.map(place => place.display_name);
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    return [];
                }
            }

            // Debounce function to limit API calls
            function debounce(func, delay) {
                let debounceTimer;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // Initialize Awesomplete for Booking Pickup
            const awesompletePickup = new Awesomplete(pickupInput, {
                minChars: 3,
                maxItems: 5,
                autoFirst: true
            });

            pickupInput.addEventListener('input', debounce(async function() {
                const query = this.value;
                if (query.length < 3) {
                    awesompletePickup.list = [];
                    return;
                }
                const suggestions = await fetchSuggestions(query);
                awesompletePickup.list = suggestions;
            }, 300)); // 300ms debounce

            // Initialize Awesomplete for Booking Drop
            const awesompleteDrop = new Awesomplete(dropInput, {
                minChars: 3,
                maxItems: 5,
                autoFirst: true
            });

            dropInput.addEventListener('input', debounce(async function() {
                const query = this.value;
                if (query.length < 3) {
                    awesompleteDrop.list = [];
                    return;
                }
                const suggestions = await fetchSuggestions(query);
                awesompleteDrop.list = suggestions;
            }, 300)); // 300ms debounce

            // Trigger map update when a suggestion is selected (Booking Form)
            pickupInput.addEventListener('awesomplete-selectcomplete', async function() {
                const address = this.value;
                const location = await geocodeAddress(address);
                if (location) {
                    setPickupLocation(location.lat, location.lon);
                }
            });

            dropInput.addEventListener('awesomplete-selectcomplete', async function() {
                const address = this.value;
                const location = await geocodeAddress(address);
                if (location) {
                    setDropLocation(location.lat, location.lon);
                }
            });
        }

        // --- Map Initialization Code ---
        let map, pickupMarker, dropMarker;
        let mapClickCount = 0;

// Initialize Leaflet Map
window.onload = function() {
    initializeMap();
};

function initializeMap() {
    const map = L.map('map', { zoomControl: true }).setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add a delay to ensure that the map container is fully sized
    setTimeout(() => {
        map.invalidateSize();
    }, 500); // Experiment with the delay if needed

    // Handle resizing
    window.addEventListener("resize", () => {
        map.invalidateSize();
    });
}


        // Handle map clicks to set pickup and drop markers
        async function onMapClick(e) {
            const { lat, lng } = e.latlng;
            mapClickCount++;

            if (mapClickCount === 1) {
                await setPickupLocation(lat, lng);
            } else if (mapClickCount === 2) {
                await setDropLocation(lat, lng);
                fitMapBounds();
                mapClickCount = 0;
                fadeOutInstructions();
            }
        }

        // Set Pickup Marker with Reverse Geocoding
        async function setPickupLocation(lat, lng) {
            const address = await reverseGeocode(lat, lng);
            if (pickupMarker) {
                pickupMarker.setLatLng([lat, lng]).bindPopup(`<strong>Pickup:</strong> ${address}`).openPopup();
            } else {
                pickupMarker = L.marker([lat, lng], { draggable: true }).addTo(map)
                    .bindPopup(`<strong>Pickup:</strong> ${address}`).openPopup();
                pickupMarker.on('dragend', async function(event) {
                    const newPos = event.target.getLatLng();
                    const newAddress = await reverseGeocode(newPos.lat, newPos.lng);
                    document.getElementById('pickup').value = newAddress;
                    pickupMarker.bindPopup(`<strong>Pickup:</strong> ${newAddress}`).openPopup();
                });
            }
            document.getElementById('pickup').value = address;
        }

        // Set Drop Marker with Reverse Geocoding
        async function setDropLocation(lat, lng) {
            const address = await reverseGeocode(lat, lng);
            if (dropMarker) {
                dropMarker.setLatLng([lat, lng]).bindPopup(`<strong>Drop:</strong> ${address}`).openPopup();
            } else {
                dropMarker = L.marker([lat, lng], { draggable: true }).addTo(map)
                    .bindPopup(`<strong>Drop:</strong> ${address}`).openPopup();
                dropMarker.on('dragend', async function(event) {
                    const newPos = event.target.getLatLng();
                    const newAddress = await reverseGeocode(newPos.lat, newPos.lng);
                    document.getElementById('drop').value = newAddress;
                    dropMarker.bindPopup(`<strong>Drop:</strong> ${newAddress}`).openPopup();
                });
            }
            document.getElementById('drop').value = address;
        }

        // Fit the map view to include both pickup and drop markers
        function fitMapBounds() {
            if (pickupMarker && dropMarker) {
                const bounds = L.latLngBounds([pickupMarker.getLatLng(), dropMarker.getLatLng()]);
                map.fitBounds(bounds.pad(0.5));
            }
        }

        // Fade out instructions
        function fadeOutInstructions() {
            const instructions = document.getElementById('mapInstructions');
            if (instructions) {
                instructions.classList.add('fade-out');
                setTimeout(() => instructions.remove(), 1000);
            }
        }

        // Reverse Geocoding Function (Example using Nominatim)
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                return data.display_name || 'Unknown Location';
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                return 'Unknown Location';
            }
        }

        // Geocode an address using Nominatim
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(address)}`, {
                    headers: {
                        'Accept-Language': 'en' // Optional: set language
                    }
                });
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                } else {
                    return null;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // Header scroll effect
        window.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            if (window.scrollY > 50) {
                header.style.background = 'rgba(255, 255, 255, 0.98)';
                header.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            } else {
                header.style.background = 'rgba(255, 255, 255, 0.95)';
                header.style.boxShadow = 'none';
            }

            // Toggle hamburger menu visibility
            const hamburger = document.getElementById('hamburgerMenu');
            if (window.innerWidth <= 768) {
                hamburger.style.display = 'block';
            } else {
                hamburger.style.display = 'none';
                navLinks.classList.remove('active');
            }
        });

        // Hamburger Menu Toggle
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const navLinks = document.getElementById('navLinks');

        hamburgerMenu.addEventListener('click', () => {
            navLinks.classList.toggle('active');
        });

        // Logout function
        function logout() {
            localStorage.removeItem('userToken');
            window.location.href = 'login.html';
        }

        // Check for token in localStorage
        const token = localStorage.getItem('userToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        const bookingForm = document.getElementById('bookingForm');
        const messageDiv = document.getElementById('formMessage');
        const authErrorDiv = document.getElementById('authError');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');

        // Show message with appropriate styling
        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.classList.remove('success', 'error');
            element.classList.add(isError ? 'error' : 'success');
            element.style.display = 'block';
        }

        // Hide messages
        function hideMessages() {
            messageDiv.style.display = 'none';
            authErrorDiv.style.display = 'none';
        }

        // Retrieve query parameters and pre-fill the form
        function prefillFormFromQueryParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const pickup = decodeURIComponent(urlParams.get('pickup') || '');
            const drop = decodeURIComponent(urlParams.get('drop') || '');
            const date = urlParams.get('date') || '';

            if (pickup) {
                document.getElementById('pickup').value = pickup;
                setPickupFromPrefill(pickup);
            }
            if (drop) {
                document.getElementById('drop').value = drop;
                setDropFromPrefill(drop);
            }
            if (date) {
                document.getElementById('date').value = date;
            }

            // Update price if necessary
            if (pickup || drop || document.getElementById('passengers').value) {
                updatePrice();
            }
        }

        // Set Pickup Location from Prefill
        async function setPickupFromPrefill(address) {
            const location = await geocodeAddress(address);
            if (location) {
                setPickupLocation(location.lat, location.lon);
            }
        }

        // Set Drop Location from Prefill
        async function setDropFromPrefill(address) {
            const location = await geocodeAddress(address);
            if (location) {
                setDropLocation(location.lat, location.lon);
            }
        }

        // Update price based on inputs
        function updatePrice() {
            const basePrice = 5000;
            const distanceMultiplier = 50; // Simulated value
            const pickup = document.getElementById('pickup').value.trim();
            const drop = document.getElementById('drop').value.trim();
            const passengers = parseInt(document.getElementById('passengers').value, 10);

            if (pickup && drop && passengers) {
                // Simulate price calculation
                const distance = Math.floor(Math.random() * 100) + 50; // Random distance between 50 and 150 km
                const price = basePrice + (distance * distanceMultiplier) + (passengers * 1000);
                document.getElementById('price').value = price;
            } else {
                document.getElementById('price').value = '';
            }
        }

        // Validate date and time
        function validateDateTime() {
            const dateInput = document.getElementById('date');
            const timeInput = document.getElementById('time');
            const selectedDate = new Date(`${dateInput.value}T${timeInput.value}`);
            const now = new Date();

            if (selectedDate < now) {
                showMessage(authErrorDiv, 'Selected date and time must be in the future.', true);
                return false;
            }
            return true;
        }

        // Taxi Availability Check
        async function checkTaxiAvailability(formData) {
            try {
                // Extract relevant fields
                const { pickup, drop, date, passengers } = formData;
                
                // Ensure required fields are present
                if (!pickup || !drop || !date) {
                    showMessage(authErrorDiv, 'Please fill in all required fields.', true);
                    return {
                        available: false,
                        taxis: []
                    };
                }

                const availabilityPayload = {
                    pickup,
                    drop,
                    date
                };

                // **UPDATED API ENDPOINT FOR TAXI AVAILABILITY**
                const response = await fetch('http://localhost:3000/api/availableTaxis', { // Changed from /api/bookings/availableTaxis to /api/availableTaxis
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify(availabilityPayload)
                });

                if (!response.ok) {
                    let errorMessage = `Server responded with status ${response.status}`;
                    const errorData = await response.json().catch(() => null);
                    if (errorData && errorData.message) {
                        errorMessage += `: ${errorData.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                if (data.success) {
                    if (data.taxis && data.taxis.length > 0) {
                        let availableTaxis = data.taxis;
                        
                        // If passengers specified, filter by capacity
                        if (passengers) {
                            availableTaxis = data.taxis.filter(taxi => {
                                return (
                                    taxi.status === 'available' && 
                                    taxi.capacity >= parseInt(passengers)
                                );
                            });
                        }

                        // Format taxi information for display
                        const formattedTaxis = availableTaxis.map(taxi => ({
                            id: taxi._id,
                            vehicleModel: taxi.vehicleModel,
                            licensePlate: taxi.licensePlate,
                            capacity: taxi.capacity,
                            sourceLocation: taxi.sourceLocation,
                            destinationLocation: taxi.destinationLocation,
                            available: taxi.status === 'available'
                        }));

                        return {
                            available: formattedTaxis.length > 0,
                            taxis: formattedTaxis,
                            message: formattedTaxis.length > 0 
                                ? `Found ${formattedTaxis.length} suitable taxi(s)`
                                : 'No taxis available matching your criteria'
                        };
                    }

                    return {
                        available: false,
                        taxis: [],
                        message: 'No taxis available for this route'
                    };
                } else {
                    showMessage(authErrorDiv, data.message || 'Unable to check taxi availability.', true);
                    return {
                        available: false,
                        taxis: [],
                        message: data.message || 'Unable to check taxi availability'
                    };
                }
            } catch (error) {
                const errorMessage = `An error occurred while checking taxi availability: ${error.message}`;
                showMessage(authErrorDiv, errorMessage, true);
                console.error('Error:', error);
                return {
                    available: false,
                    taxis: [],
                    message: errorMessage
                };
            }
        }

        // Handle form submission
        bookingForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessages();
            resultsSection.innerHTML = ''; // Clear previous results

            const formData = {
                pickup: document.getElementById('pickup').value.trim(),
                drop: document.getElementById('drop').value.trim(),
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                passengers: parseInt(document.getElementById('passengers').value, 10)
            };

            // Validate date and time
            if (!validateDateTime()) {
                return;
            }

            // Check taxi availability
            loadingSpinner.style.display = 'block';
            const availability = await checkTaxiAvailability(formData);
            loadingSpinner.style.display = 'none';

            if (!availability.available) {
                showMessage(authErrorDiv, availability.message, true);
                return;
            }

            // Display available taxis
            if (availability.taxis && availability.taxis.length > 0) {
                resultsSection.innerHTML = ''; // Clear any previous messages
                availability.taxis.forEach(taxi => {
                    const card = document.createElement('div');
                    card.className = 'result-card';

                    card.innerHTML = `
                        <div class="result-details">
                            <h3>${taxi.sourceLocation} to ${taxi.destinationLocation}</h3>
                            <p>Vehicle Model: ${taxi.vehicleModel}</p>
                            <p>License Plate: ${taxi.licensePlate}</p>
                            <p>Capacity: ${taxi.capacity}</p>
                        </div>
                        <div>
                            <button class="book-btn" onclick="confirmBooking('${taxi.id}', '${encodeURIComponent(taxi.sourceLocation)}', '${encodeURIComponent(taxi.destinationLocation)}', '${formData.date}', '${encodeURIComponent(taxi.vehicleModel)}', '${encodeURIComponent(taxi.licensePlate)}')">Book Now</button>
                        </div>
                    `;

                    resultsSection.appendChild(card);
                });
            } else {
                resultsSection.innerHTML = '<div class="error-message">No taxis available for the selected criteria.</div>';
            }
        });

        // Confirm Booking Function
        async function confirmBooking(taxiId, pickup, drop, date, vehicleModel, licensePlate) {
            // Decode the URI components
            pickup = decodeURIComponent(pickup);
            drop = decodeURIComponent(drop);
            vehicleModel = decodeURIComponent(vehicleModel);
            licensePlate = decodeURIComponent(licensePlate);

            const formData = {
                pickup,
                drop,
                date,
                time: document.getElementById('time').value,
                passengers: parseInt(document.getElementById('passengers').value, 10),
                taxiId
            };

            try {
                loadingSpinner.style.display = 'block';
                // **UPDATED API ENDPOINT FOR BOOKING**
                const response = await fetch('http://localhost:3000/api/bookings', { // Changed from /api/bookFlight to /api/bookings
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    let errorMessage = `Server responded with status ${response.status}`;
                    const errorData = await response.json().catch(() => null);
                    if (errorData && errorData.message) {
                        errorMessage += `: ${errorData.message}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                loadingSpinner.style.display = 'none';

                if (response.ok && data.success) {
                    showMessage(messageDiv, 'Booking confirmed successfully! Redirecting to payment...', false);
                    setTimeout(() => {
                        // Redirect to payment gateway with booking ID
                        window.location.href = `payment.html?bookingId=${data.booking._id}`; // Changed from data.booking.id to data.booking._id
                    }, 2000);
                } else {
                    // Handle specific error messages
                    if (data.errors) {
                        const errorMessages = data.errors.map(err => err.msg).join(', ');
                        showMessage(authErrorDiv, errorMessages, true);
                    } else {
                        showMessage(authErrorDiv, data.message || 'Booking failed. Please try again.', true);
                    }
                }
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showMessage(authErrorDiv, `An error occurred while confirming booking: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        // Initialize user preferences (e.g., saving frequent routes)
        function initializeUserPreferences() {
            // Fetch saved preferences from backend
            // This is a placeholder. Implement actual API call to fetch user preferences.
        }

        // Instructions Overlay Functions
        function showMapInstructions(message) {
            const instructions = document.getElementById('mapInstructions');
            instructions.innerHTML = `<p><strong>Instructions:</strong> ${message}</p>`;
            instructions.classList.remove('fade-out');
            instructions.style.opacity = '1';
            instructions.style.visibility = 'visible';
        }

        function hideMapInstructions() {
            const instructions = document.getElementById('mapInstructions');
            instructions.classList.add('fade-out');

            // Remove the instructions from the DOM after the transition
            setTimeout(() => {
                instructions.remove();
            }, 1000); // Match this duration with the CSS transition duration
        }

        // Call prefill function on page load
        window.addEventListener('DOMContentLoaded', (event) => {
            // Initialize map first
            initializeMap();

            // Then initialize other components
            initializeAutocomplete();
            prefillFormFromQueryParams();
            updatePrice();
            initializeUserPreferences();
        });

        // Update price when form inputs change
        document.getElementById('pickup').addEventListener('input', updatePrice);
        document.getElementById('drop').addEventListener('input', updatePrice);
        document.getElementById('passengers').addEventListener('change', updatePrice);
    </script>
</body>
</html>
